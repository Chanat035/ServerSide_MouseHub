<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | MouseHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: "Prompt", sans-serif;
            background: #f5f5f5;
            color: #000;
        }

        /* HEADER */
        .navbar-custom {
            background-color: #000;
            padding: 0.8rem 2rem;
        }

        .navbar-brand {
            color: #ffb500 !important;
            font-weight: 700;
            text-decoration: none;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            top: 70px;
            left: 0;
            width: 200px;
            background-color: #ddd;
            height: calc(100vh - 70px);
        }

        .sidebar-item {
            padding: 15px 20px;
            border-bottom: 1px solid #bbb;
            cursor: pointer;
        }

        .sidebar-item.active {
            background-color: #ff8c00;
            color: #fff;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 200px;
            margin-top: 70px;
            padding: 20px;
        }

        /* TABLE */
        table {
            width: 100%;
            background: #fff;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f7f7f7;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .status-paid {
            color: green;
            font-weight: bold;
        }

        .status-unpaid {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <nav class="navbar navbar-custom fixed-top">
        <a class="navbar-brand" href="/">üê≠ MouseHub</a>
    </nav>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-item active">My Orders</div>
        <div class="sidebar-item" onclick="logout()">Logout</div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <h2>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Item</th>
                        <th>Total (‡∏ö‡∏≤‡∏ó)</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Payment Status</th>
                    </tr>
                </thead>
                <tbody id="orderBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        async function getOrdersByUserId() {
            const tbody = document.getElementById("orderBody");

            try {
                const res = await fetch("/api/orders"); // endpoint ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const orders = await res.json();

                if (!Array.isArray(orders) || orders.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</td></tr>";
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const date = new Date(order.createdAt);
                    const formattedDate = `${String(date.getDate()).padStart(2,"0")}/${String(date.getMonth()+1).padStart(2,"0")}/${date.getFullYear()}`;

                    return `
                        <tr>
                            <td>${order._id}</td>
                            <td>${order.items.map(i => i.name).join(", ")}</td>
                            <td>${order.totalAmount.toFixed(2)} ‡∏ø</td>
                            <td>${order.shippingAddress}</td>
                            <td>${order.status}</td>
                            <td class="${order.paymentStatus==='paid' ? 'status-paid' : 'status-unpaid'}">
                                ${order.paymentStatus==='paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞'}
                            </td>
                        </tr>
                    `;
                }).join("");

            } catch (err) {
                console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
                tbody.innerHTML = "<tr><td colspan='6' class='text-center text-danger'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>";
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏à‡πÄ‡∏õ‡∏¥‡∏î
        getOrdersByUserId();

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô logout
        async function logout() {
            if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

            try {
                const response = await fetch("/logout", {
                    method: "POST",
                    credentials: "include"
                });

                if (response.ok) {
                    alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                    window.location.href = "/";
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                }
            } catch (error) {
                console.error("Logout error:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö");
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
