<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orders | MouseHub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
  <!-- รวม header -->
  <%- include('partials/header') %>

  <main class="container mt-5 pt-4 text-light">
    <h2 class="text-warning mb-4">คำสั่งซื้อของฉัน</h2>

    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>วันที่สั่งซื้อ</th>
            <th>รวมทั้งหมด (บาท)</th>
            <th>สถานะ</th>
            <th>การชำระเงิน</th>
            <th>ดูสินค้า</th>
          </tr>
        </thead>
        <tbody id="orderBody">
          <tr>
            <td colspan="6" class="text-center text-muted">กำลังโหลดคำสั่งซื้อ...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal แสดงรายละเอียดสินค้า -->
  <div class="modal fade" id="orderItemsModal" tabindex="-1" aria-labelledby="orderItemsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-0">
          <h5 class="modal-title text-warning" id="orderItemsModalLabel">รายละเอียดสินค้าในคำสั่งซื้อ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="orderItemsContainer" class="table-responsive">
            <table class="table table-dark table-striped">
              <thead>
                <tr>
                  <th>ชื่อสินค้า</th>
                  <th>ราคา (บาท)</th>
                  <th>จำนวน</th>
                  <th>รวม</th>
                </tr>
              </thead>
              <tbody id="orderItemsBody">
                <tr>
                  <td colspan="4" class="text-center text-muted">กำลังโหลด...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function getOrdersByUserId() {
      const tbody = document.getElementById("orderBody");

      try {
        const res = await fetch("/api/orders");
        const orders = await res.json();

        if (!Array.isArray(orders) || orders.length === 0) {
          tbody.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>ไม่มีคำสั่งซื้อ</td></tr>";
          return;
        }

        tbody.innerHTML = orders.map(order => {
          const date = new Date(order.createdAt);
          const formattedDate = `${String(date.getDate()).padStart(2, "0")}/${String(date.getMonth() + 1).padStart(2, "0")}/${date.getFullYear()}`;

          return `
            <tr>
              <td>${order._id}</td>
              <td>${formattedDate}</td>
              <td>${order.totalAmount.toFixed(2)} ฿</td>
              <td>${order.status}</td>
              <td class="${order.paymentStatus === 'paid' ? 'text-success fw-bold' : 'text-danger fw-bold'}">
                ${order.paymentStatus === 'paid' ? 'ชำระแล้ว' : 'ยังไม่ชำระ'}
              </td>
              <td><button class="btn btn-sm btn-warning" onclick='showOrderItems(${JSON.stringify(order.items)})'>ดูสินค้า</button></td>
            </tr>
          `;
        }).join("");

      } catch (err) {
        console.error("❌ โหลดข้อมูลล้มเหลว:", err);
        tbody.innerHTML = "<tr><td colspan='6' class='text-center text-danger'>โหลดข้อมูลไม่สำเร็จ</td></tr>";
      }
    }

    function showOrderItems(items) {
      const tbody = document.getElementById("orderItemsBody");

      if (!items || items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">ไม่มีสินค้า</td></tr>`;
      } else {
        tbody.innerHTML = items.map(i => `
          <tr>
            <td>${i.name}</td>
            <td>${i.price.toFixed(2)}</td>
            <td>${i.quantity}</td>
            <td>${(i.price * i.quantity).toFixed(2)}</td>
          </tr>
        `).join("");
      }

      const modal = new bootstrap.Modal(document.getElementById("orderItemsModal"));
      modal.show();
    }

    getOrdersByUserId();
  </script>

  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> -->
</body>

</html>
